<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë ˆì‹œí”¼</title>

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #fafafa;
      overflow-x: hidden;
    }
    
    @media (max-width: 768px) {
      html, body {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
      }

      * {
        max-width: 100%;
        box-sizing: border-box;
      }
    }
    
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #ffffff;
      border-bottom: 1px solid #ddd;
      padding: 12px 16px;
    }
    header h1 {
      margin: 0 0 10px 0;
      font-size: 20px;
      text-align: center;
    }
    .filter {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .filter select,
    .filter input {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    header button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      background: #4CAF50;
      color: white;
    }
    main {
      padding: 16px;
    }
    .recipe {
      background: white;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    .recipe h3 { margin: 0 0 6px 0; }
    .meta { font-size: 13px; color: #666; margin-bottom: 6px; }
    .details { display: none; margin-top: 8px; }
    .details.show { display: block; }
    .actions { margin-top: 8px; text-align: right; }
    .actions button {
      font-size: 13px;
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      background: #ddd;
      margin-left: 4px;
    }
    .favorite { background: gold; }
    #formView { display: none; }
label {
      display: block;
      margin-top: 14px;
      font-weight: bold;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    textarea {
      resize: vertical;
      min-height: 240px; /* âœ… ê¸°ì¡´ ìš”ì²­ëŒ€ë¡œ ë†’ì´ 2ë°° ìœ ì§€ */
    }

    .checkbox-group {
      display: flex;
      gap: 16px;
      margin-top: 8px;
    }

    .form-buttons {
      margin-top: 24px;
      display: flex;
      gap: 10px;
    }

    .form-buttons button {
      flex: 1;
      padding: 12px;
      font-size: 15px;
      border-radius: 8px;
      border: none;
    }

    .save {
      background: #2196F3;
      color: white;
    }

    .back {
      background: #ccc;
    }

    .empty {
      color: #777;
      text-align: center;
      margin-top: 40px;
    }
  </style>
</head>

<body>

<header>
  <h1>ë ˆì‹œí”¼</h1>
  <div class="filter">
    <select id="filterCategory">
      <option value="">ì „ì²´ ë¶„ë¥˜</option>
      <option value="ì£¼ì‹">ì£¼ì‹</option>
      <option value="ë°˜ì°¬">ë°˜ì°¬</option>
      <option value="êµ­">êµ­</option>
      <option value="ê°„ì‹">ê°„ì‹</option>
    </select>
    <select id="filterTarget">
      <option value="">ì „ì²´</option>
      <option value="í•œë‚˜">í•œë‚˜</option>
      <option value="ì˜ˆë‚˜">ì˜ˆë‚˜</option>
      <option value="ì–´ë¥¸">ì–´ë¥¸</option>
    </select>
    <select id="filterFavorite">
      <option value="">ì „ì²´</option>
      <option value="favorite">ì¦ê²¨ì°¾ê¸°</option>
    </select>
    <input type="text" id="filterIngredient" placeholder="ë ˆì‹œí”¼ ê²€ìƒ‰" />
  </div>
  <button id="addBtn">+ ë ˆì‹œí”¼ ì¶”ê°€</button>
</header>

<main>
  <section id="listView">
    <div id="recipeList"></div>
  </section>

  <section id="formView">
    <label>ë ˆì‹œí”¼ ì´ë¦„</label>
    <input type="text" id="title" />

    <label>ëˆ„ê°€ ë¨¹ì—ˆë‚˜ìš”</label>
    <div class="checkbox-group">
      <label><input type="checkbox" value="í•œë‚˜" /> í•œë‚˜</label>
      <label><input type="checkbox" value="ì˜ˆë‚˜" /> ì˜ˆë‚˜</label>
      <label><input type="checkbox" value="ì–´ë¥¸" /> ì–´ë¥¸</label>
    </div>

    <label>ë¶„ë¥˜</label>
    <select id="category">
      <option value="">ì„ íƒí•˜ì„¸ìš”</option>
      <option value="ì£¼ì‹">ì£¼ì‹</option>
      <option value="ë°˜ì°¬">ë°˜ì°¬</option>
      <option value="êµ­">êµ­</option>
      <option value="ê°„ì‹">ê°„ì‹</option>
    </select>

    <label>ì¡°ë¦¬ ë°©ë²•</label>
    <textarea id="method"></textarea>

    <label>ë©”ëª¨</label>
    <textarea id="memo"></textarea>

    <div class="form-buttons">
      <button class="save" id="saveBtn">ì €ì¥</button>
      <button class="back" id="backBtn">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    onSnapshot,
    addDoc,
    updateDoc,
    deleteDoc,
    doc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  /* ===== Firebase ì´ˆê¸°í™” ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyAwkEUsRcn-y2E5t8jaJ0dpRYxqHZSFAmM",
    authDomain: "hyrecipes-9741c.firebaseapp.com",
    projectId: "hyrecipes-9741c",
    storageBucket: "hyrecipes-9741c.appspot.com",
    messagingSenderId: "162012587383",
    appId: "1:162012587383:web:f8e6f21579a16d76912d72"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const recipesStore = collection(db, "recipes");

  /* ===== ê¸°ì¡´ ì „ì—­ ë³€ìˆ˜ ===== */
  let allRecipes = [];
  let editingId = null;

  /* ğŸ”´ ë™ì‹œ ìˆ˜ì • ê°ì§€ìš© ê¸°ì¤€ ì‹œê°„ */
  let editingBaseUpdatedAt = null;

  /* ===== ì‹¤ì‹œê°„ ë™ê¸°í™” ===== */
  onSnapshot(recipesStore, (snapshot) => {
    allRecipes = snapshot.docs.map(d => ({
      id: d.id,
      ...d.data()
    }));
    applyFilter();
  });

  /* ===== í•„í„° / ë Œë”ë§ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ) ===== */
  function applyFilter() {
    recipeList.innerHTML = "";

    const category = filterCategory.value;
    const target = filterTarget.value;
    const favorite = filterFavorite.value;
    const keyword = filterIngredient.value.toLowerCase();

    const filtered = allRecipes
      .filter(r => {
        const matchCategory = !category || r.category === category;
        const matchTarget = !target || r.targets.includes(target);
        const matchFavorite = !favorite || r.favorite === true;
        const matchKeyword = !keyword || r.title.toLowerCase().includes(keyword);
        return matchCategory && matchTarget && matchFavorite && matchKeyword;
      })
      .sort((a, b) => a.title.localeCompare(b.title, "ko"));

    if (filtered.length === 0) {
      recipeList.innerHTML = `<div class="empty">ì¡°ê±´ì— ë§ëŠ” ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
      return;
    }

    filtered.forEach(r => {
      const div = document.createElement("div");
      div.className = "recipe";

      div.innerHTML = `
        <h3>${r.title}</h3>
        <div class="meta">${r.targets.join(", ")} Â· ${r.category}</div>

        <div class="details">
          <p><strong>ì¡°ë¦¬ ë°©ë²•</strong><br>${r.method.replace(/\n/g, "<br>")}</p>
          ${r.memo ? `<p><strong>ë©”ëª¨</strong><br>${r.memo.replace(/\n/g, "<br>")}</p>` : ""}
        </div>

        <div class="actions">
          <button onclick="toggleFavorite('${r.id}')" class="${r.favorite ? 'favorite' : ''}">
            ${r.favorite ? 'â˜…' : 'â˜†'}
          </button>
          <button onclick="toggleDetails(this)">âˆ¨</button>
          <button onclick="editRecipe('${r.id}')">ìˆ˜ì •</button>
          <button onclick="deleteRecipe('${r.id}')">ì‚­ì œ</button>
        </div>
      `;

      recipeList.appendChild(div);
    });
  }

  /* ===== UI í† ê¸€ ===== */
  window.toggleDetails = btn => {
    btn.closest(".recipe").querySelector(".details").classList.toggle("show");
  };

  /* ===== ì¦ê²¨ì°¾ê¸° ===== */
  window.toggleFavorite = async id => {
    const recipe = allRecipes.find(r => r.id === id);
    await updateDoc(doc(db, "recipes", id), {
      favorite: !recipe.favorite,
      updatedAt: serverTimestamp()
    });
  };

  /* ===== ì‚­ì œ ===== */
  window.deleteRecipe = async id => {
    if (!confirm("ì‚­ì œ í•˜ê² ìŠµë‹ˆê¹Œ?")) return;
    await deleteDoc(doc(db, "recipes", id));
  };

  /* ===== ìˆ˜ì • ===== */
  window.editRecipe = id => {
    const recipe = allRecipes.find(r => r.id === id);
    editingId = id;

    /* ğŸ”´ ê¸°ì¤€ ì‹œê° ì €ì¥ */
    editingBaseUpdatedAt = recipe.updatedAt || null;

    title.value = recipe.title;
    method.value = recipe.method;
    memo.value = recipe.memo;
    category.value = recipe.category;

    document.querySelectorAll(".checkbox-group input").forEach(c => {
      c.checked = recipe.targets.includes(c.value);
    });

    listView.style.display = "none";
    formView.style.display = "block";
    window.scrollTo({ top: 0 });
  };

  /* ===== í•„í„° ì´ë²¤íŠ¸ ===== */
  filterCategory.onchange =
  filterTarget.onchange =
  filterFavorite.onchange =
  filterIngredient.oninput = applyFilter;

  /* ===== ì¶”ê°€ ===== */
  addBtn.onclick = () => {
    editingId = null;
    editingBaseUpdatedAt = null;

    document.querySelectorAll("input, textarea").forEach(e => e.value = "");
    document.querySelectorAll(".checkbox-group input").forEach(c => c.checked = false);
    category.value = "";

    listView.style.display = "none";
    formView.style.display = "block";
  };

  /* ===== ëŒì•„ê°€ê¸° ===== */
  backBtn.onclick = () => {
    formView.style.display = "none";
    listView.style.display = "block";
  };

  /* ===== ì €ì¥ ===== */
  saveBtn.onclick = async () => {
    const data = {
      title: title.value.trim(),
      method: method.value.trim(),
      memo: memo.value.trim(),
      category: category.value,
      targets: [...document.querySelectorAll(".checkbox-group input:checked")].map(c => c.value),
      favorite: editingId
        ? allRecipes.find(r => r.id === editingId).favorite
        : false,
      updatedAt: serverTimestamp()
    };

    if (!data.title || !data.method || !data.category || data.targets.length === 0) {
      alert("í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”");
      return;
    }

    /* ğŸ”´ ë™ì‹œ ìˆ˜ì • ê²½ê³  */
    if (editingId && editingBaseUpdatedAt) {
      const latest = allRecipes.find(r => r.id === editingId);

      if (
        latest.updatedAt &&
        latest.updatedAt.seconds !== editingBaseUpdatedAt.seconds
      ) {
        const proceed = confirm(
          "ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì´ ë ˆì‹œí”¼ê°€ ì´ë¯¸ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\nê·¸ë˜ë„ ë®ì–´ì“¸ê¹Œìš”?"
        );
        if (!proceed) return;
      }
    }

    if (editingId === null) {
      await addDoc(recipesStore, data);
    } else {
      await updateDoc(doc(db, "recipes", editingId), data);
    }

    formView.style.display = "none";
    listView.style.display = "block";
  };
</script>




</body>
</html>
